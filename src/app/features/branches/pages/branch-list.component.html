<div class="space-y-6">
    <!-- Header -->
    <app-page-header title="Branch Management" subtitle="Manage physical branch locations and assignments">
        <div actions class="flex gap-3">
            <button (click)="loadBranches()" [disabled]="loading()" class="btn-secondary" title="Refresh">
                <i class="pi pi-refresh" [class.pi-spin]="loading()"></i>
            </button>
            <a routerLink="/dashboard/branches/new" class="btn-primary">
                <i class="pi pi-plus mr-2"></i> Add Branch
            </a>
        </div>
    </app-page-header>

    <!-- Toolbar -->
    <app-page-toolbar>
        <app-search-input placeholder="Search branches..." (search)="onSearch($event)">
        </app-search-input>

        <div class="flex items-center gap-3">
            <app-sort-dropdown [options]="sortOptions" (sortChange)="onDropdownSort($event)">
            </app-sort-dropdown>
        </div>
    </app-page-toolbar>

    <!-- Error Message -->
    <div *ngIf="error()" class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-3 text-red-700">
        <i class="pi pi-exclamation-triangle"></i>
        <span>{{ error() }}</span>
        <button class="ml-auto text-sm font-medium hover:underline" (click)="loadBranches()">Try Again</button>
    </div>

    <!-- Table -->
    <app-card-table>
        <app-table-header [columns]="columns" [hasActions]="true" (sort)="onHeaderSort($event)">
        </app-table-header>

        <!-- Loading -->
        <tr *ngIf="loading()">
            <td colspan="5" class="p-8 text-center text-gray-500">
                <i class="pi pi-spinner pi-spin text-3xl mb-2"></i>
                <p>Loading branches...</p>
            </td>
        </tr>

        <!-- Empty -->
        <tr *ngIf="!loading() && branches().length === 0">
            <td colspan="5" class="p-12 text-center text-gray-500">
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="pi pi-map-marker text-2xl text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">No branches found</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by adding a new branch.</p>
                </div>
            </td>
        </tr>

        <!-- Rows -->
        <app-table-row *ngFor="let branch of branches()">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div
                        class="h-10 w-10 flex-shrink-0 rounded-full bg-brand-soft text-brand-main flex items-center justify-center font-bold text-lg">
                        {{ branch.name.charAt(0) }}
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">{{ branch.name }}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="flex flex-col">
                    <span class="text-sm text-gray-900">{{ branch.address }}</span>
                    <span class="text-xs text-gray-500">{{ branch.city }}, {{ branch.state }} {{ branch.zipCode
                        }}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div class="flex items-center gap-2">
                    <i class="pi pi-phone text-xs"></i>
                    <span>{{ branch.phone }}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span *ngIf="hasCoordinates(branch)"
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <i class="pi pi-map-marker mr-1"></i>
                    {{ branch.latitude | number:'1.4-4' }}, {{ branch.longitude | number:'1.4-4' }}
                </span>
                <span *ngIf="!hasCoordinates(branch)"
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    No coordinates
                </span>
            </td>

            <!-- Actions -->
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end gap-2">
                    <a [routerLink]="['/dashboard/branches', branch.id]"
                        class="p-1.5 text-gray-400 hover:text-brand-main rounded-md transition-colors"
                        title="View Details">
                        <i class="pi pi-eye"></i>
                    </a>
                    <button (click)="viewOnMap(branch)" [disabled]="!hasCoordinates(branch)"
                        class="p-1.5 text-gray-400 hover:text-green-600 rounded-md transition-colors disabled:opacity-50"
                        title="View on Map">
                        <i class="pi pi-map"></i>
                    </button>
                    <a [routerLink]="['/dashboard/branches', branch.id, 'edit']"
                        class="p-1.5 text-gray-400 hover:text-blue-600 rounded-md transition-colors" title="Edit">
                        <i class="pi pi-pencil"></i>
                    </a>
                    <button (click)="confirmDelete(branch)"
                        class="p-1.5 text-gray-400 hover:text-red-600 rounded-md transition-colors" title="Delete">
                        <i class="pi pi-trash"></i>
                    </button>
                </div>
            </td>
        </app-table-row>

        <!-- Pagination -->
        <app-pagination [page]="currentPage()" [pageSize]="pageSize()" [total]="totalItems()"
            (pageChange)="onPageChange($event)" (pageSizeChange)="onPageSizeChange($event)">
        </app-pagination>
    </app-card-table>
</div>

<!-- Delete Confirmation Modal -->
<app-confirmation-modal [isOpen]="isDeleteModalOpen()" title="Delete Branch"
    [message]="'Are you sure you want to delete ' + (branchToDelete()?.name || '') + '? This action cannot be undone.'"
    confirmLabel="Delete" confirmBtnClass="bg-red-500 hover:bg-red-600" (confirm)="onDeleteConfirmed()"
    (close)="isDeleteModalOpen.set(false)">
</app-confirmation-modal>